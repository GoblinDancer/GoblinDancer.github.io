const API_GET = 'https://fcc1t9cb2d.execute-api.eu-north-1.amazonaws.com/default/GetTimerValue';
const API_UPDATE = 'https://tgkm2ga3g9.execute-api.eu-north-1.amazonaws.com/default/UpdateTimer';

const countdownElement = document.getElementById('countdown-timer');
let remainingSeconds = 0;
let updateInterval;

function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const pad = num => num.toString().padStart(2, '0');
    return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
}

function startCountdown() {
    if (updateInterval) clearInterval(updateInterval);
    updateInterval = setInterval(() => {
        if (remainingSeconds > 0) {
            remainingSeconds--;
            countdownElement.textContent = formatTime(remainingSeconds);
        } else {
            countdownElement.textContent = "00:00:00";
        }
    }, 1000);
}

function updateTimer() {
    fetch(API_GET)
        .then(res => res.json())
        .then(data => {
            remainingSeconds = data.remainingSeconds;
            countdownElement.textContent = formatTime(remainingSeconds);
            startCountdown();
        })
        .catch(err => console.error("Fehler beim Abrufen des Timer-Werts:", err));
}

// --- PayPal Button ---
paypal.Buttons({
    createOrder: (data, actions) => {
        return actions.order.create({
            purchase_units: [{ amount: { value: '1.00' } }] // 1â‚¬ = 1h
        });
    },
    onApprove: (data, actions) => {
        return actions.order.capture().then(details => {
            fetch(API_UPDATE, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ transaction_id: data.orderID })
            })
            .then(res => res.json())
            .then(r => {
                console.log("Lambda Antwort:", r);
                updateTimer(); // sofort neuen Wert holen
            })
            .catch(err => console.error("Fehler bei Lambda:", err));
        });
    }
}).render('#paypal-button-container');

// --- Beim Laden Timer holen ---
updateTimer();
