<script>
const API_GET = 'https://fcc1t9cb2d.execute-api.eu-north-1.amazonaws.com/default/GetTimerValue';
const API_UPDATE = 'https://tgkm2ga3g9.execute-api.eu-north-1.amazonaws.com/default/UpdateTimer';

const countdownElement = document.getElementById('countdown-timer');
const inactiveGoblin = document.getElementById('inactive-goblin');
const activeGoblin = document.getElementById('active-goblin');
const backgroundMusic = document.getElementById('background-music');

let remainingSeconds = 0;
let countdownStarted = false;

// Formatierung: HH:MM:SS
function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const pad = num => num.toString().padStart(2, '0');
    return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
}

// Timer vom Server holen und lokal updaten
function updateTimerFromServer() {
    fetch(API_GET)
        .then(res => res.json())
        .then(data => {
            const endTimestamp = data.endTimestamp || 0;
            const now = Math.floor(Date.now() / 1000);
            remainingSeconds = Math.max(0, endTimestamp - now);

            countdownElement.textContent = formatTime(remainingSeconds);

            // Goblin Animation & Musik
            if (remainingSeconds > 0) {
                inactiveGoblin.style.opacity = 0;
                activeGoblin.style.opacity = 1;
                try { backgroundMusic.play(); } catch(e){ /* Autoplay blockiert */ }
            } else {
                inactiveGoblin.style.opacity = 1;
                activeGoblin.style.opacity = 0;
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;
            }

            // Countdown starten, falls noch nicht gestartet
            if (!countdownStarted) {
                startCountdown();
                countdownStarted = true;
            }
        })
        .catch(err => {
            console.error("Fehler beim Abrufen des Timer-Werts:", err);
            countdownElement.textContent = 'Fehler!';
        });
}

// Countdown Sekunde für Sekunde
function startCountdown() {
    setInterval(() => {
        if (remainingSeconds > 0) {
            remainingSeconds--;
            countdownElement.textContent = formatTime(remainingSeconds);
        } else {
            countdownElement.textContent = "00:00:00";
        }
    }, 1000);
}

// Timer initial holen + alle 30 Sekunden aktualisieren
updateTimerFromServer();
setInterval(updateTimerFromServer, 30000);

// PayPal Button
paypal.Buttons({
    createOrder: (data, actions) => {
        return actions.order.create({
            purchase_units: [{ amount: { value: '1.00' } }] // 1€ = 1h
        });
    },
    onApprove: (data, actions) => {
        return actions.order.capture().then(details => {
            console.log('Zahlung erfolgreich:', details);
            // Order-ID an Lambda senden
            fetch(API_UPDATE, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ transaction_id: data.orderID })
            })
            .then(res => res.json())
            .then(r => {
                console.log("Lambda Antwort:", r);
                updateTimerFromServer(); // sofort neuen Wert holen
            })
            .catch(err => console.error("Fehler bei Lambda:", err));
        });
    }
}).render('#paypal-button-container');
</script>
